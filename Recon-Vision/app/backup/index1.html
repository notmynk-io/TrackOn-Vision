<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="css/style.css">
<title>B.S.C. // INTRUDER DETECTION SYSTEM</title>
</head>
<body>

<header>// BORDER SURVEILLANCE SYSTEM // INTRUDER DETECTION SYSTEM //</header>

<main>
  <section class="video-section panel">
    <h2>// LIVE FEED // SECTOR 7G</h2>
    <img id="video-feed" src="http://localhost:8000/video_feed" alt="Live video stream" />
  </section>

  <aside class="right-panel">
    <section class="stats-section panel">
      <h3>// DETECTION STATS //</h3>
      <table id="stats-table">
        <thead>
          <tr><th>CLASS</th><th>COUNT</th></tr>
        </thead>
        <tbody id="stats-body">
          <tr><td>PERSON</td><td id="person-count">0</td></tr>
          <tr><td>BIRD</td><td id="bird-count">0</td></tr>
          <tr><td>ANIMAL</td><td id="animal-count">0</td></tr>
        </tbody>
      </table>
    </section>

    <section class="intruders-section panel">
        <h2>// INTRUDER ALERTS //</h2>
        <div id="intruders-grid"></div>
    </section>
  </aside>
</main>

<footer>STATUS: <span id="status">CONNECTING...</span> | POWERED BY YOLOV8 & GEMINI</footer>

<audio id="alert-sound" src="warning.mp3" preload="auto"></audio>

<script>
  const personCountElem = document.getElementById('person-count');
  const birdCountElem = document.getElementById('bird-count');
  const animalCountElem = document.getElementById('animal-count');
  const intrudersGrid = document.getElementById('intruders-grid');
  const statusElem = document.getElementById('status');
  const alertSound = document.getElementById('alert-sound');

  const socket = new WebSocket("ws://localhost:8000/ws");

  // Store intruder data and timers
  const intruders = new Map();

  socket.onopen = function(event) {
    console.log("WebSocket connection established.");
    statusElem.textContent = "OPERATIONAL";
    statusElem.style.color = "var(--primary-color)";
  };

  socket.onmessage = function(event) {
    const message = JSON.parse(event.data);

    if (message.type === 'alert') {
      handleIntruderAlert(message);
    } else if (message.type === 'stats') {
      handleStats(message.data);
    }
  };

  socket.onclose = function(event) {
    console.log("WebSocket connection closed.");
    statusElem.textContent = "CONNECTION LOST";
    statusElem.style.color = "var(--danger-color)";
  };

  socket.onerror = function(error) {
    console.error("WebSocket error:", error);
    statusElem.textContent = "CONNECTION ERROR";
    statusElem.style.color = "var(--danger-color)";
  };

  function handleIntruderAlert(alertData) {
    // Assuming the backend sends a unique ID for each intruder
    const intruderId = alertData.intruder_id || `intruder_${Date.now()}`;
    const imageUrl = alertData.image_url;
    const confidence = alertData.details[0].confidence.toFixed(2);

    if (!intruders.has(intruderId)) {
      // New intruder detected
      const card = document.createElement('div');
      card.className = 'intruder-card';
      card.id = `intruder-${intruderId}`;
      intrudersGrid.prepend(card);

      const newIntruder = {
        card: card,
        imageTimer: null,
        removalTimer: null
      };
      intruders.set(intruderId, newIntruder);
      alertSound.play().catch(e => console.error("Audio play failed:", e));
    }

    const intruder = intruders.get(intruderId);

    // Update card content
    intruder.card.innerHTML = `
        <h4>INTRUDER ID: ${intruderId}</h4>
        <div class="intruder-details">
            <div>Confidence: ${confidence}</div>
            <div class="timestamp">Last Seen: ${new Date().toLocaleString()}</div>
        </div>
        <img class="intruder-image" src="${imageUrl}" alt="Intruder Snapshot" />
    `;

    // Clear existing timers
    clearTimeout(intruder.imageTimer);
    clearTimeout(intruder.removalTimer);

    // Set a timer to remove the image after 5 seconds
    intruder.imageTimer = setTimeout(() => {
        const img = intruder.card.querySelector('.intruder-image');
        if (img) {
            img.style.opacity = '0';
        }
    }, 5000);

    // Set a timer to remove the entire card after a longer period of inactivity (e.g., 30 seconds)
    intruder.removalTimer = setTimeout(() => {
        intruder.card.remove();
        intruders.delete(intruderId);
    }, 30000);
  }

  function handleStats(statsData) {
    personCountElem.textContent = statsData.person || 0;
    birdCountElem.textContent = statsData.bird || 0;
    animalCountElem.textContent = statsData.animal || 0;
  }

</script>

</body>
</html>
